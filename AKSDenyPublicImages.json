{
    "properties": {
      "displayName": "Kubernetes cluster containers should only use allowed/private images",
      "policyType": "Custom",
      "mode": "Microsoft.Kubernetes.Data",
      "description": "Use images from trusted registries to reduce the Kubernetes cluster's exposure risk to unknown vulnerabilities, security issues and malicious images. This custom policy enforces the use of images from ernpallregistry.azurecr.io on AKS clusters.",
      "version": "1.0.0",
      "parameters": {
        "source": {
          "type": "String",
          "defaultValue": "Original",
          "allowedValues": [
            "All",
            "Generated",
            "Original"
          ]
        },
        "effect": {
          "type": "String",
          "defaultValue": "Deny",
          "allowedValues": [
            "audit",
            "Audit",
            "deny",
            "Deny",
            "disabled",
            "Disabled"
          ]
        },
        "excludedNamespaces": {
          "type": "Array",
          "defaultValue": [
            "kube-system",
            "gatekeeper-system",
            "azure-arc",
            "azure-extensions-usage-system",
            "cert-manager",
            "cnpg-system",
            "default",
            "kube-node-lease",
            "kube-public"
          ]
        },
        "namespaces": {
          "type": "Array",
          "defaultValue": []
        },
        "allowedContainerImagesRegex": {
          "type": "String",
          "defaultValue": "^ernpallregistry\\.azurecr\\.io/.+$"
        },
        "excludedContainers": {
          "type": "Array",
          "defaultValue": []
        }
      },
      "policyRule": {
        "if": {
          "field": "type",
          "equals": "Microsoft.ContainerService/managedClusters"
        },
        "then": {
          "effect": "[parameters('effect')]",
          "details": {
            "source": "[parameters('source')]",
            "templateInfo": {
              "sourceType": "PublicURL",
              "url": "https://store.policy.core.windows.net/kubernetes/container-allowed-images/v2/template.yaml"
            },
            "apiGroups": [
              ""
            ],
            "kinds": [
              "Pod"
            ],
            "excludedNamespaces": "[parameters('excludedNamespaces')]",
            "namespaces": "[parameters('namespaces')]",
            "values": {
              "imageRegex": "[parameters('allowedContainerImagesRegex')]",
              "excludedContainers": "[parameters('excludedContainers')]"
            }
          }
        }
      }
    },
    "type": "Microsoft.Authorization/policyDefinitions",
    "name": "AKSDenyPublicImages"
}